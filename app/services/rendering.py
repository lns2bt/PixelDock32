FONT_5X7 = {
    " ": ["00000", "00000", "00000", "00000", "00000", "00000", "00000"],
    ":": ["00000", "00100", "00000", "00000", "00100", "00000", "00000"],
    ".": ["00000", "00000", "00000", "00000", "00000", "00100", "00000"],
    "-": ["00000", "00000", "00000", "01110", "00000", "00000", "00000"],
    "0": ["01110", "10001", "10011", "10101", "11001", "10001", "01110"],
    "1": ["00100", "01100", "00100", "00100", "00100", "00100", "01110"],
    "2": ["01110", "10001", "00001", "00010", "00100", "01000", "11111"],
    "3": ["11110", "00001", "00001", "01110", "00001", "00001", "11110"],
    "4": ["00010", "00110", "01010", "10010", "11111", "00010", "00010"],
    "5": ["11111", "10000", "10000", "11110", "00001", "00001", "11110"],
    "6": ["00110", "01000", "10000", "11110", "10001", "10001", "01110"],
    "7": ["11111", "00001", "00010", "00100", "01000", "10000", "10000"],
    "8": ["01110", "10001", "10001", "01110", "10001", "10001", "01110"],
    "9": ["01110", "10001", "10001", "01111", "00001", "00010", "11100"],
    "A": ["01110", "10001", "10001", "11111", "10001", "10001", "10001"],
    "B": ["11110", "10001", "10001", "11110", "10001", "10001", "11110"],
    "C": ["01110", "10001", "10000", "10000", "10000", "10001", "01110"],
    "D": ["11110", "10001", "10001", "10001", "10001", "10001", "11110"],
    "E": ["11111", "10000", "10000", "11110", "10000", "10000", "11111"],
    "F": ["11111", "10000", "10000", "11110", "10000", "10000", "10000"],
    "G": ["01110", "10001", "10000", "10111", "10001", "10001", "01110"],
    "H": ["10001", "10001", "10001", "11111", "10001", "10001", "10001"],
    "I": ["01110", "00100", "00100", "00100", "00100", "00100", "01110"],
    "J": ["00001", "00001", "00001", "00001", "10001", "10001", "01110"],
    "K": ["10001", "10010", "10100", "11000", "10100", "10010", "10001"],
    "k": ["10000", "10010", "10100", "11000", "10100", "10010", "10001"],
    "L": ["10000", "10000", "10000", "10000", "10000", "10000", "11111"],
    "M": ["10001", "11011", "10101", "10101", "10001", "10001", "10001"],
    "N": ["10001", "11001", "10101", "10011", "10001", "10001", "10001"],
    "O": ["01110", "10001", "10001", "10001", "10001", "10001", "01110"],
    "P": ["11110", "10001", "10001", "11110", "10000", "10000", "10000"],
    "Q": ["01110", "10001", "10001", "10001", "10101", "10010", "01101"],
    "R": ["11110", "10001", "10001", "11110", "10100", "10010", "10001"],
    "S": ["01111", "10000", "10000", "01110", "00001", "00001", "11110"],
    "T": ["11111", "00100", "00100", "00100", "00100", "00100", "00100"],
    "U": ["10001", "10001", "10001", "10001", "10001", "10001", "01110"],
    "V": ["10001", "10001", "10001", "10001", "10001", "01010", "00100"],
    "W": ["10001", "10001", "10001", "10101", "10101", "10101", "01010"],
    "X": ["10001", "10001", "01010", "00100", "01010", "10001", "10001"],
    "Y": ["10001", "10001", "01010", "00100", "00100", "00100", "00100"],
    "Z": ["11111", "00001", "00010", "00100", "01000", "10000", "11111"],
    "€": ["01111", "10000", "11110", "10000", "11110", "10000", "01111"],
}

FONT_3X5 = {
    " ": ["000", "000", "000", "000", "000"],
    ":": ["000", "010", "000", "010", "000"],
    ".": ["000", "000", "000", "000", "010"],
    "-": ["000", "000", "111", "000", "000"],
    "0": ["111", "101", "101", "101", "111"],
    "1": ["010", "110", "010", "010", "111"],
    "2": ["111", "001", "111", "100", "111"],
    "3": ["111", "001", "111", "001", "111"],
    "4": ["101", "101", "111", "001", "001"],
    "5": ["111", "100", "111", "001", "111"],
    "6": ["111", "100", "111", "101", "111"],
    "7": ["111", "001", "001", "010", "010"],
    "8": ["111", "101", "111", "101", "111"],
    "9": ["111", "101", "111", "001", "111"],
    "A": ["111", "101", "111", "101", "101"],
    "B": ["110", "101", "110", "101", "110"],
    "C": ["111", "100", "100", "100", "111"],
    "D": ["110", "101", "101", "101", "110"],
    "E": ["111", "100", "110", "100", "111"],
    "F": ["111", "100", "110", "100", "100"],
    "G": ["111", "100", "101", "101", "111"],
    "H": ["101", "101", "111", "101", "101"],
    "I": ["111", "010", "010", "010", "111"],
    "J": ["001", "001", "001", "101", "111"],
    "K": ["101", "101", "110", "101", "101"],
    "k": ["100", "101", "110", "101", "101"],
    "L": ["100", "100", "100", "100", "111"],
    "M": ["101", "111", "111", "101", "101"],
    "N": ["101", "111", "111", "111", "101"],
    "O": ["111", "101", "101", "101", "111"],
    "P": ["111", "101", "111", "100", "100"],
    "Q": ["111", "101", "101", "111", "001"],
    "R": ["111", "101", "111", "110", "101"],
    "S": ["111", "100", "111", "001", "111"],
    "T": ["111", "010", "010", "010", "010"],
    "U": ["101", "101", "101", "101", "111"],
    "V": ["101", "101", "101", "101", "010"],
    "W": ["101", "101", "111", "111", "101"],
    "X": ["101", "101", "010", "101", "101"],
    "Y": ["101", "101", "010", "010", "010"],
    "Z": ["111", "001", "010", "100", "111"],
    "€": ["111", "100", "110", "100", "111"],
}


VALID_FONT_SIZES = {"small", "normal"}


def normalize_font_size(font_size: str | None) -> str:
    if isinstance(font_size, str) and font_size.lower() in VALID_FONT_SIZES:
        return font_size.lower()
    return "normal"


def blank_frame(width: int = 32, height: int = 8) -> list[list[int]]:
    return [[0 for _ in range(width)] for _ in range(height)]


def blank_color_frame(width: int = 32, height: int = 8) -> list[list[tuple[int, int, int] | None]]:
    return [[None for _ in range(width)] for _ in range(height)]


def normalize_char_spacing(char_spacing: int | None, font_size: str = "normal") -> int:
    default_spacing = 1
    if char_spacing is None:
        return default_spacing
    try:
        spacing = int(char_spacing)
    except (TypeError, ValueError):
        return default_spacing
    max_spacing = 3 if normalize_font_size(font_size) == "small" else 4
    return max(0, min(max_spacing, spacing))


def _glyph_columns(glyph: list[str]) -> tuple[int, int]:
    first = None
    last = None
    for row in glyph:
        for x, pixel in enumerate(row):
            if pixel != "1":
                continue
            if first is None or x < first:
                first = x
            if last is None or x > last:
                last = x

    if first is None or last is None:
        return 0, 1
    return first, (last - first) + 1


def measure_text_width(text: str, font_size: str = "normal", char_spacing: int | None = None) -> int:
    selected_size = normalize_font_size(font_size)
    glyphs = FONT_3X5 if selected_size == "small" else FONT_5X7
    spacing = normalize_char_spacing(char_spacing, selected_size)

    width = 0
    for idx, char in enumerate(text):
        glyph = glyphs.get(char, glyphs.get(char.upper(), glyphs[" "]))
        _, glyph_width = _glyph_columns(glyph)
        width += glyph_width
        if idx < len(text) - 1:
            width += spacing
    return max(width, 1)


def render_text_frame(
    text: str,
    width: int = 32,
    height: int = 8,
    font_size: str = "normal",
    x_offset: int = 0,
    y_offset: int = 0,
) -> list[list[int]]:
    frame, _ = render_text_with_colors(
        text=text,
        width=width,
        height=height,
        font_size=font_size,
        x_offset=x_offset,
        y_offset=y_offset,
    )
    return frame


def render_text_with_colors(
    text: str,
    char_colors: list[tuple[int, int, int]] | None = None,
    width: int = 32,
    height: int = 8,
    font_size: str = "normal",
    x_offset: int = 0,
    y_offset: int = 0,
    base_color: tuple[int, int, int] = (80, 80, 80),
    char_spacing: int | None = None,
) -> tuple[list[list[int]], list[list[tuple[int, int, int] | None]]]:
    frame = blank_frame(width, height)
    color_frame = blank_color_frame(width, height)
    x_cursor = x_offset

    selected_size = normalize_font_size(font_size)
    glyphs = FONT_3X5 if selected_size == "small" else FONT_5X7
    top_offset = 2 if selected_size == "small" else 1
    spacing = normalize_char_spacing(char_spacing, selected_size)

    for idx, char in enumerate(text):
        glyph = glyphs.get(char, glyphs.get(char.upper(), glyphs[" "]))
        lead, glyph_width = _glyph_columns(glyph)
        color = base_color
        if char_colors and idx < len(char_colors):
            color = char_colors[idx]

        for y, row in enumerate(glyph):
            for x, pixel in enumerate(row):
                out_y = y + top_offset + y_offset
                out_x = x_cursor + x - lead
                if 0 <= out_y < height and 0 <= out_x < width and pixel == "1":
                    frame[out_y][out_x] = 1
                    color_frame[out_y][out_x] = color

        x_cursor += glyph_width + spacing
        if x_cursor >= width:
            break

    return frame, color_frame
